#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'fileutils'
require 'optparse'
require 'yaml'
require 'kafo/configuration'


# Option Parsing
name = ARGV[0]

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: kafofy [installer_name]"
  opts.on("-c", "--config_file FILE", "location of the configuration file") do |config_file|
    options[:config_file] = config_file
  end
  options[:answers_file] = './config/answers.yaml'
  opts.on("-a", "--answers_file FILE", "location of the answers file") do |answers_file|
    options[:answers_file] = answers_file
  end
end.parse!

config = Kafo::Configuration::DEFAULT
config[:answer_file] = options[:answers_file]

# Create directory structure
%w(bin config modules).each do |dir|
  FileUtils.mkdir_p dir
end

# Copy config files
src = File.expand_path(File.join(File.dirname(__FILE__), '..'))
%w(config_header.txt kafo.yaml.example).each do |file|
  FileUtils.cp src + "/config/#{file}", 'config/'
end

script_name = "kafo-configure"
# Optional configure script
if name
  if !options[:config_file]
    options[:config_file] = "./config/#{name}.yaml"
    puts "using #{options[:config_file]} as default config file"
    if !File.exists?(options[:config_file])
      puts "... creating config file #{options[:config_file]}"
      FileUtils.touch options[:config_file]
      File.chmod 0600, options[:config_file]
      File.open(options[:config_file], 'w') { |file| file.write(YAML.dump(config).gsub('!ruby/sym ', ':'))}
    end
  end
  script_name = "bin/#{name}"
  puts "... creating #{script_name}"
  content = <<EOS
#!/usr/bin/env ruby
require 'rubygems'
CONFIG_FILE = '#{options[:config_file]}'
ANSWERS_FILE = '#{options[:answers_file]}'
require 'kafo'
result = Kafo::KafoConfigure.run
exit result.nil? ? 0 : result.exit_code
EOS
  File.open(script_name, 'w') { |file| file.write(content) }
  FileUtils.chmod 0755, script_name
end

puts "Your directory was kafofied"

puts "Now you should:"
puts "  1. upload your puppet modules to modules directory (you can use librarian-puppet project)"
puts "  2. create default config/answers.yaml or modify config/kafo.yaml to load another answer file"
puts "  3. run #{script_name}"
